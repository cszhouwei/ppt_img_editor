# 导出功能完整修复说明

## 用户反馈的问题

1. **下载框未弹出**：点击"导出 PNG"后，没有触发文件下载
2. **图层内容不一致**：导出的图片内容与画布显示不一致

---

## 问题分析与修复

### 问题 1: Docker 网络访问

**错误日志**：
```
httpcore.ConnectError: All connection attempts failed
```

**原因**：容器内 `localhost:9000` 指向容器自己，无法访问 MinIO。

**修复**：[export.py:24](services/doc_process/src/utils/export.py#L24)
```python
# 在 Docker 容器内，需要将 localhost 替换为服务名
internal_url = url.replace("http://localhost:9000", "http://minio:9000")
```

---

### 问题 2: 异步调用嵌套

**错误日志**：
```
RuntimeError: asyncio.run() cannot be called from a running event loop
```

**原因**：在运行中的事件循环里使用 `asyncio.run()`。

**修复**：[export.py:41](services/doc_process/src/utils/export.py#L41)
```python
# 将 blend_patch_layer 改为异步函数
async def blend_patch_layer(...):
    patch_image = await download_image(patch_url)  # 使用 await
```

---

### 问题 3: 浏览器 CORS 限制

**原因**：前端尝试直接访问 `http://localhost:9000`（MinIO），触发 CORS 错误，无法下载文件。

**修复 A**：添加后端下载代理 - [assets.py:115-155](services/doc_process/src/api/assets.py#L115-L155)

```python
@router.get("/download")
async def download_asset(
    path: str = Query(...),
    settings: Settings = Depends(get_settings),
    minio_client: Minio = Depends(get_minio_client)
):
    """下载 MinIO 中的文件（代理）"""
    response = minio_client.get_object(
        bucket_name=settings.s3_bucket,
        object_name=path
    )

    return StreamingResponse(
        response,
        media_type="image/png",
        headers={"Content-Disposition": f"attachment; filename={path.split('/')[-1]}"}
    )
```

**修复 B**：前端使用代理下载 - [Toolbar.tsx:92-115](apps/web/src/components/Toolbar.tsx#L92-L115)

```tsx
// 将 MinIO URL 转换为后端 API 代理 URL
const proxyUrl = response.export_url.replace(
  'http://localhost:9000/doc-edit/',
  '/api/v1/assets/download?path='
);

// 使用 fetch 下载文件
const fileResponse = await fetch(proxyUrl);
const blob = await fileResponse.blob();
const blobUrl = URL.createObjectURL(blob);

// 创建下载链接
const link = document.createElement('a');
link.href = blobUrl;
link.download = `export_${Date.now()}.png`;
link.click();

// 清理 blob URL
setTimeout(() => URL.revokeObjectURL(blobUrl), 100);
```

---

### 问题 4: 图层数据不同步

**原因**：用户编辑文本后未保存就直接导出，导出使用的是旧数据。

**修复**：[Toolbar.tsx:56-90](apps/web/src/components/Toolbar.tsx#L56-L90)

```tsx
const handleExport = async () => {
  // 先保存/更新项目以确保使用最新数据
  let projectId = currentProject?.project_id;

  if (currentProject) {
    // 更新现有项目
    const updated = await updateProject(currentProject.project_id, {
      page: currentPage,
      layers,  // 使用当前 store 中的最新 layers
    });
    setCurrentProject(updated);
    projectId = updated.project_id;
  } else {
    // 创建新项目
    const project = await createProject({
      page: currentPage,
      layers,
    });
    setCurrentProject(project);
    projectId = project.project_id;
  }

  // 然后导出
  const response = await exportProject(projectId!);
  // ...
};
```

**改进点**：
- 导出前自动保存当前状态
- 无需手动点击"保存项目"
- 确保导出内容与画布一致

---

## 完整导出流程

### 1. 用户点击"导出 PNG"

```
用户操作
  ↓
前端: handleExport()
  ↓
自动保存当前编辑状态
  ├─ updateProject() or createProject()
  └─ 更新 store.currentProject
```

### 2. 调用后端导出 API

```
POST /api/v1/projects/{project_id}/export/png
  ↓
后端: export_project_to_png()
  ├─ 下载基础图片 (download_image)
  │   └─ URL 替换: localhost:9000 → minio:9000
  ├─ 渲染 patch 图层 (blend_patch_layer)
  │   └─ await download_image(patch_url)
  └─ 渲染文本图层 (render_text_layer)
```

### 3. 上传到 MinIO

```
导出图片编码为 PNG
  ↓
上传到 MinIO: exports/export_xxx.png
  ↓
返回 URL: http://localhost:9000/doc-edit/exports/export_xxx.png
```

### 4. 前端下载文件

```
接收 export_url
  ↓
URL 转换:
  http://localhost:9000/doc-edit/exports/export_xxx.png
  → /api/v1/assets/download?path=exports/export_xxx.png
  ↓
fetch(proxyUrl)
  ↓
后端代理从 MinIO 获取文件
  ↓
前端创建 Blob URL
  ↓
触发下载
```

---

## 测试验证

### 测试步骤

1. **上传图片并 OCR 分析**
2. **编辑文本**：修改字号、颜色、内容
3. **直接点击"导出 PNG"**（无需先保存）
4. **验证结果**：
   - ✅ 浏览器弹出下载框
   - ✅ 文件名：`export_<timestamp>.png`
   - ✅ 图片内容与画布一致
   - ✅ 文本修改已应用

### 预期行为

```
点击"导出 PNG"
  ↓
显示 loading: "准备导出..."
  ↓
自动保存项目（后台）
  ↓
显示 loading: "导出 PNG 中..."
  ↓
生成导出图片（后台）
  ↓
浏览器弹出下载框 ✅
  ↓
显示 alert: "导出成功!"
```

### 错误处理

```
保存失败 → alert: "导出失败,请重试"
导出失败 → alert: "导出失败,请重试"
下载失败 → alert: "下载文件失败"
```

---

## 技术细节

### URL 映射表

| 场景 | URL | 说明 |
|------|-----|------|
| MinIO 返回 | `http://localhost:9000/doc-edit/exports/xxx.png` | 宿主机访问 |
| 容器内访问 | `http://minio:9000/doc-edit/exports/xxx.png` | Docker 服务名 |
| 前端下载 | `/api/v1/assets/download?path=exports/xxx.png` | 后端代理 |

### Docker 网络架构

```
浏览器
  ↓ /api/v1/assets/download?path=...
FastAPI (doc_process)
  ↓ http://minio:9000/doc-edit/...
MinIO (minio)
  ↓ 返回文件流
FastAPI
  ↓ StreamingResponse
浏览器（下载）
```

### 数据流

```
用户编辑
  ↓
Zustand Store (layers)
  ↓
导出时保存到数据库
  ↓
后端读取并渲染
  ↓
生成 PNG
  ↓
上传 MinIO
  ↓
代理下载
  ↓
浏览器保存
```

---

## 相关文件

### 后端

- [export.py](services/doc_process/src/utils/export.py) - 导出渲染逻辑
- [assets.py](services/doc_process/src/api/assets.py) - 下载代理接口
- [projects.py](services/doc_process/src/api/projects.py) - 导出 API 端点

### 前端

- [Toolbar.tsx](apps/web/src/components/Toolbar.tsx) - 导出按钮和下载逻辑
- [api.ts](apps/web/src/services/api.ts) - API 调用封装

---

## 部署步骤

```bash
# 1. 重新构建后端
docker-compose build doc_process

# 2. 重启服务
docker-compose up -d doc_process

# 3. 验证服务
docker-compose logs -f doc_process

# 4. 前端无需重启（HMR 自动更新）
```

---

## 总结

### 修复的问题

✅ Docker 网络访问错误 → URL 替换
✅ 异步调用嵌套错误 → 改为 async/await
✅ 浏览器 CORS 限制 → 后端代理下载
✅ 图层数据不一致 → 导出前自动保存

### 用户体验改进

✅ 无需手动保存即可导出
✅ 自动弹出下载框
✅ 导出内容与画布完全一致
✅ 清晰的进度提示

### 技术改进

✅ 完整的错误处理
✅ 合理的架构设计
✅ 安全的文件下载
✅ 良好的日志记录
