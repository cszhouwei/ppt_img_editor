# 文字颜色估计优化说明

## 问题背景

OCR 识别的文字内容准确率高，但颜色估计误差大，主要原因：
1. **背景干扰**：文字边缘会采样到背景色
2. **阴影/高光**：文字可能有渐变、阴影效果
3. **简单算法**：之前只使用中位数，容易被干扰

## 优化方案

### 新增四种颜色估计方法

#### 1. K-means 聚类法（推荐，默认）
**方法名**: `kmeans`

**原理**:
- 使用形态学腐蚀收缩 mask，避免边缘背景
- K-means 聚类找到 3 个主色调（文字、阴影、高光）
- 选择最大簇作为主色调

**适用场景**:
- ✅ 纯色文字
- ✅ 有轻微渐变的文字
- ✅ 复杂背景

**示例**:
```bash
curl -X POST http://localhost:8080/v1/pages/page_xxx/estimate-style \
  -H "Content-Type: application/json" \
  -d '{
    "candidate_id": "cand_xxx",
    "color_method": "kmeans"
  }'
```

#### 2. 边缘腐蚀法
**方法名**: `edge`

**原理**:
- 深度腐蚀 mask 到笔画中心
- 提取笔画中心的颜色
- 使用中位数估计

**适用场景**:
- ✅ 有明显边缘效果的文字
- ✅ 粗体文字
- ⚠️ 细小文字可能完全被腐蚀

**示例**:
```bash
curl -X POST http://localhost:8080/v1/pages/page_xxx/estimate-style \
  -H "Content-Type: application/json" \
  -d '{
    "candidate_id": "cand_xxx",
    "color_method": "edge"
  }'
```

#### 3. 改进中位数法
**方法名**: `median`

**原理**:
- 排除亮度极端值（20-80 百分位）
- 使用中位数估计颜色

**适用场景**:
- ✅ 一般场景
- ✅ 简单背景

**示例**:
```bash
curl -X POST http://localhost:8080/v1/pages/page_xxx/estimate-style \
  -H "Content-Type: application/json" \
  -d '{
    "candidate_id": "cand_xxx",
    "color_method": "median"
  }'
```

#### 4. 均值法
**方法名**: `mean`

**原理**:
- 直接计算所有像素的均值

**适用场景**:
- ✅ 快速估计
- ⚠️ 容易被背景污染

## 使用建议

### 默认配置
```json
{
  "color_method": "kmeans"
}
```

### 调试模式
开启 debug 可以查看估计细节：

```bash
curl -X POST http://localhost:8080/v1/pages/page_xxx/estimate-style \
  -H "Content-Type: application/json" \
  -d '{
    "candidate_id": "cand_xxx",
    "color_method": "kmeans",
    "debug": true
  }'
```

**响应示例**:
```json
{
  "candidate_id": "cand_xxx",
  "style": {
    "fontFamily": "System",
    "fontSize": 32,
    "fontWeight": 600,
    "fill": "rgba(45,67,89,1.00)",
    "letterSpacing": 0,
    "lineHeight": 1.2,
    "debug": {
      "color_rgb": [45, 67, 89],
      "method": "kmeans",
      "sample_count": 1234
    }
  }
}
```

### 场景选择建议

| 场景 | 推荐方法 | 理由 |
|------|---------|------|
| 纯色文字 + 复杂背景 | `kmeans` | 聚类能有效分离文字和背景 |
| 渐变文字 | `kmeans` | 聚类找主色调 |
| 粗体/大字 | `edge` | 笔画中心颜色最纯 |
| 细小文字 | `kmeans` 或 `median` | 避免过度腐蚀 |
| 简单背景 | `median` | 效率高 |
| 快速预览 | `mean` | 最快但最不准 |

## 前端集成

修改前端 API 调用，传递颜色方法：

```typescript
// apps/web/src/services/api.ts
export async function estimateStyle(
  pageId: string,
  candidateId: string,
  colorMethod: string = 'kmeans'
): Promise<EstimateStyleResponse> {
  const response = await fetch(
    `${API_BASE_URL}/v1/pages/${pageId}/estimate-style`,
    {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        candidate_id: candidateId,
        color_method: colorMethod,
        debug: false
      }),
    }
  );
  return response.json();
}
```

## 性能对比

| 方法 | 速度 | 准确度 | 内存 |
|------|------|--------|------|
| `kmeans` | 中 | ⭐⭐⭐⭐⭐ | 中 |
| `edge` | 快 | ⭐⭐⭐⭐ | 低 |
| `median` | 快 | ⭐⭐⭐ | 低 |
| `mean` | 最快 | ⭐⭐ | 最低 |

## 进一步优化方向

1. **自适应方法选择**: 根据文字大小、背景复杂度自动选择最优方法
2. **多方法融合**: 结合多个方法的结果，投票或加权平均
3. **深度学习**: 使用预训练模型直接估计文字颜色
4. **用户反馈**: 允许用户手动调整颜色，学习优化算法

## 测试建议

1. 准备多种测试图片：
   - 纯色背景 + 纯色文字
   - 复杂背景 + 纯色文字
   - 渐变背景 + 渐变文字
   - 小字号文字
   - 粗体文字

2. 对比四种方法的效果

3. 根据实际场景选择最优方法

## 更新日志

- 2025-12-29: 新增 K-means 聚类方法（默认）
- 2025-12-29: 新增边缘腐蚀方法
- 2025-12-29: 改进中位数方法（更严格的异常值过滤）
- 2025-12-29: 添加调试模式
