# 查看颜色估计日志

## 日志输出改进

现在样式估计 API 会在日志中输出详细的估计信息。

## 查看日志

### 方法 1: 实时查看日志
```bash
docker-compose logs -f doc_process
```

### 方法 2: 只看最近的日志
```bash
docker-compose logs --tail=50 doc_process
```

### 方法 3: 过滤样式估计日志
```bash
docker-compose logs doc_process | grep "Style estimated"
```

## 日志示例

当你点击 OCR 候选框生成图层时，你会看到类似这样的日志：

```
2025-12-29 15:45:32,123 - src.api.pages - INFO - Estimating style for page=page_xxx, candidate=page_xxx_c_003
2025-12-29 15:45:32,456 - src.api.pages - INFO - Style estimated for page_xxx_c_003: method=kmeans, color=rgba(45,67,89,1.00), fontSize=32px, fontWeight=600
```

### 日志信息说明

| 字段 | 含义 | 示例值 |
|------|------|--------|
| `method` | 使用的颜色估计方法 | `kmeans` / `median` / `edge` / `mean` |
| `color` | 估计的文字颜色（RGBA 格式） | `rgba(45,67,89,1.00)` |
| `fontSize` | 估计的字号（像素） | `32px` |
| `fontWeight` | 估计的字重 | `400`(normal) / `600`(semibold) / `700`(bold) |

## 测试不同颜色方法

### 使用默认方法（K-means）
正常使用前端，日志会显示：
```
method=kmeans, color=rgba(45,67,89,1.00), fontSize=32px, fontWeight=600
```

### 使用其他方法（需要修改前端代码）

在 [EditorCanvas.tsx](../apps/web/src/components/EditorCanvas.tsx) 中临时修改：

```typescript
// 找到这行（大约第 315 行）
estimateStyle(currentPage.page_id, candidate.id),

// 改为
estimateStyle(currentPage.page_id, candidate.id, {
  colorMethod: 'edge',  // 或 'median' / 'mean'
  debug: false
}),
```

然后重新构建前端：
```bash
cd apps/web && npm run build
```

### 开启调试模式

修改为：
```typescript
estimateStyle(currentPage.page_id, candidate.id, {
  colorMethod: 'kmeans',
  debug: true  // 开启调试
}),
```

这样你在浏览器控制台和后端日志中都能看到额外的调试信息。

## 对比不同方法的效果

### 测试步骤

1. 准备一张 PPT 截图（特别是有复杂背景的）
2. 上传并进行 OCR 分析
3. 分别测试四种方法：
   - `kmeans` （默认，推荐）
   - `edge` （适合粗体文字）
   - `median` （适合简单背景）
   - `mean` （最快但最不准）
4. 查看日志中的颜色估计结果
5. 对比哪种方法最接近原文字颜色

### 示例对比

假设原文字是深蓝色 `rgb(30, 60, 120)`：

**复杂背景（彩色背景图）**：
```
method=kmeans  → color=rgba(28,58,118,1.00)  ✓ 最准确
method=edge    → color=rgba(35,65,125,1.00)  ✓ 还不错
method=median  → color=rgba(80,95,140,1.00)  ✗ 受背景污染
method=mean    → color=rgba(120,130,150,1.00) ✗ 偏差很大
```

**简单背景（白色背景）**：
```
method=kmeans  → color=rgba(30,60,120,1.00)  ✓ 准确
method=edge    → color=rgba(28,58,118,1.00)  ✓ 准确
method=median  → color=rgba(30,61,121,1.00)  ✓ 准确
method=mean    → color=rgba(31,62,122,1.00)  ✓ 基本准确
```

## 实时监控技巧

在一个终端窗口中实时查看日志：
```bash
docker-compose logs -f doc_process | grep --color=always "Style estimated"
```

这样每次估计样式时，相关信息会高亮显示，方便观察。

## 常见颜色值参考

| 颜色描述 | RGB 值 | RGBA 格式 |
|---------|--------|-----------|
| 黑色 | (0, 0, 0) | `rgba(0,0,0,1.00)` |
| 深灰 | (30, 30, 30) | `rgba(30,30,30,1.00)` |
| 白色 | (255, 255, 255) | `rgba(255,255,255,1.00)` |
| 纯蓝 | (0, 0, 255) | `rgba(0,0,255,1.00)` |
| 深蓝 | (30, 60, 120) | `rgba(30,60,120,1.00)` |
| 红色 | (255, 0, 0) | `rgba(255,0,0,1.00)` |

## 调试技巧

如果颜色估计不准确：

1. **查看日志中的估计值**
2. **尝试不同的方法**（`kmeans` → `edge` → `median`）
3. **检查原图背景复杂度**
4. **考虑文字大小**（小字用 `kmeans`，大字可用 `edge`）
5. **开启 debug 模式**查看采样像素数

### 开启 debug 后的额外信息

后端日志会显示：
```
Style estimated for page_xxx_c_003:
  method=kmeans,
  color=rgba(45,67,89,1.00),
  fontSize=32px,
  fontWeight=600,
  samples=1234 pixels
```

前端控制台会看到：
```json
{
  "candidate_id": "page_xxx_c_003",
  "style": {
    "fill": "rgba(45,67,89,1.00)",
    "fontSize": 32,
    "fontWeight": 600,
    "debug": {
      "color_rgb": [45, 67, 89],
      "method": "kmeans",
      "sample_count": 1234
    }
  }
}
```

## 性能监控

查看样式估计的耗时：
```bash
docker-compose logs doc_process | grep -E "(Estimating style|Style estimated)" | tail -20
```

通过时间戳可以计算每次估计的耗时。一般情况下：
- `kmeans`: 100-300ms
- `edge`: 50-150ms
- `median`: 50-100ms
- `mean`: <50ms
