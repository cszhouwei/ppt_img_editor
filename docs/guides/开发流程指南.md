# 开发流程指南

## 常见开发场景和解决方案

### 1. 修改后端代码后如何更新

#### 场景 A: 修改 Python 代码 (.py 文件)
```bash
make restart
```
- FastAPI 支持热重载,代码修改后会自动生效
- 如果热重载未生效,使用 `make restart` 快速重启服务

#### 场景 B: 修改依赖 (requirements.txt)
```bash
make rebuild
```
- 需要重新构建 Docker 镜像
- 会自动安装新的依赖包

#### 场景 C: 修改 mock 数据 (mock/default.json)
```bash
make rebuild
```
- Mock 数据在构建时复制到镜像中
- 必须重新构建才能生效

#### 场景 D: 修改 Dockerfile 或配置文件
```bash
docker-compose down
docker-compose build doc_process
docker-compose up -d
```

### 2. 数据库问题

#### 清除测试数据
```bash
make reset-db
```
- 清空 candidates, pages, patches, projects 表
- 保留表结构,只删除数据
- 适用于解决主键冲突等问题

#### 完全重置数据库
```bash
make clean
make dev
```
- 删除所有容器和数据卷
- 重新创建数据库和表
- 会丢失所有数据

### 3. 前端开发

#### 启动前端开发服务器
```bash
cd apps/web
npm install       # 首次运行或依赖更新后
npm run dev
```

#### 前端代码修改
- React 支持热模块替换 (HMR)
- 代码保存后浏览器会自动刷新
- 无需重启开发服务器

### 4. 常用调试命令

#### 查看后端日志
```bash
make logs
```
- 实时查看 doc_process 服务日志
- Ctrl+C 退出

#### 检查服务健康状态
```bash
make health
```
- 快速检查后端 API 是否正常
- 返回服务状态和版本信息

#### 验证上传功能
```bash
make verify
```
- 使用测试图片验证上传接口
- 返回 asset_id, image_url 等信息

#### 查看所有容器状态
```bash
docker-compose ps
```

### 5. 问题排查流程

#### 问题: 上传图片失败
1. 检查后端日志:
   ```bash
   make logs
   ```
2. 检查健康状态:
   ```bash
   make health
   ```
3. 如果是数据库错误 (如主键冲突):
   ```bash
   make reset-db
   ```

#### 问题: 前端无法连接后端
1. 确认后端服务运行:
   ```bash
   docker-compose ps
   ```
2. 确认端口映射正确:
   - 后端: http://localhost:8080
   - 前端: http://localhost:3000
3. 检查 Vite 代理配置 (apps/web/vite.config.ts)

#### 问题: Docker 构建失败
1. 清理 Docker 缓存:
   ```bash
   docker system prune -a
   ```
2. 重新构建:
   ```bash
   make clean
   make dev
   ```

### 6. 完整的开发工作流

#### 新功能开发
```bash
# 1. 确保环境运行正常
make health

# 2. 修改代码 (后端或前端)
# ...

# 3. 如果修改了后端代码
make restart        # 一般情况
# 或
make rebuild        # 修改了依赖或数据文件

# 4. 如果修改了前端代码
# 自动热重载,无需操作

# 5. 测试功能
# - 前端: http://localhost:3000
# - API文档: http://localhost:8080/docs
# - MinIO控制台: http://localhost:9001

# 6. 如果遇到数据问题
make reset-db       # 清除测试数据
```

#### Git 提交前检查
```bash
# 1. 运行测试
make test

# 2. 检查代码格式
make lint

# 3. 格式化代码
make format

# 4. 验证功能
make verify

# 5. 提交代码
git add .
git commit -m "your message"
```

### 7. 环境变量配置

#### 首次启动
```bash
make init
```
- 从 .env.example 复制到 .env
- 根据需要修改配置

#### OCR 提供商配置

**使用 Mock (默认)**
```bash
OCR_PROVIDER=mock
```

**使用 Azure**
```bash
OCR_PROVIDER=azure
AZURE_VISION_ENDPOINT=https://your-resource.cognitiveservices.azure.com/
AZURE_VISION_KEY=your-key
```

**使用 Google Cloud Vision**
```bash
OCR_PROVIDER=google
GOOGLE_CREDENTIALS_PATH=/path/to/service-account.json
# 或
GOOGLE_CREDENTIALS_JSON='{"type":"service_account",...}'
```

修改 .env 后需要重启服务:
```bash
make restart
```

### 8. 性能优化建议

#### Docker 构建优化
- 修改 Python 代码时优先使用 `make restart`
- 只有修改依赖或数据文件时才使用 `make rebuild`
- 避免频繁使用 `docker system prune -a`

#### 数据库优化
- 开发时定期使用 `make reset-db` 清理测试数据
- 避免累积大量废弃数据影响性能

#### 前端开发优化
- 使用浏览器开发者工具查看网络请求
- 利用 React DevTools 调试组件状态
- Vite 的 HMR 速度很快,无需频繁刷新页面

### 9. 常见错误和解决方案

#### Error: "duplicate key value violates unique constraint"
**原因**: 数据库中存在重复的主键
**解决**:
```bash
make reset-db
```

#### Error: "ModuleNotFoundError: No module named 'xxx'"
**原因**: 新增了 Python 依赖但未重新构建镜像
**解决**:
```bash
make rebuild
```

#### Error: "Connection refused" (前端调用后端时)
**原因**: 后端服务未启动或端口映射错误
**解决**:
```bash
make health          # 检查后端状态
docker-compose ps    # 检查容器状态
```

#### Error: Mock 数据修改未生效
**原因**: Mock 数据在构建时复制,修改本地文件不会自动同步
**解决**:
```bash
make rebuild
```

### 10. Makefile 命令速查表

| 命令 | 用途 | 使用场景 |
|------|------|----------|
| `make init` | 初始化环境 | 首次启动项目 |
| `make dev` | 启动开发环境 | 日常开发启动 |
| `make restart` | 重启后端服务 | 修改 Python 代码后 |
| `make rebuild` | 重新构建后端 | 修改依赖、mock 数据后 |
| `make logs` | 查看日志 | 调试错误 |
| `make health` | 健康检查 | 验证服务状态 |
| `make reset-db` | 清除数据库 | 解决数据冲突 |
| `make clean` | 完全清理 | 重置开发环境 |
| `make test` | 运行测试 | 提交代码前 |
| `make verify` | 验证上传 | 快速功能测试 |

### 11. 最佳实践

1. **每天开始开发前**
   ```bash
   git pull
   make health      # 确保服务正常
   ```

2. **修改代码后**
   ```bash
   # Python 代码: make restart
   # 依赖或数据: make rebuild
   # 前端代码: 自动热重载
   ```

3. **提交代码前**
   ```bash
   make test
   make lint
   make verify
   git add . && git commit
   ```

4. **遇到问题时**
   ```bash
   make logs        # 先查看日志
   make health      # 检查服务状态
   make reset-db    # 尝试清除数据
   make clean && make dev  # 最后手段
   ```

5. **定期维护**
   ```bash
   # 每周清理一次 Docker 缓存
   docker system prune

   # 每天结束时停止服务节省资源
   make down
   ```
